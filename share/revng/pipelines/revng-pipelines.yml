#
# This file is distributed under the MIT License. See LICENSE.md for details.
#

Component: revng
Containers:
  - Name: hex.dump
    Type: hex-dump
  - Name: cross-relations.yml
    Type: binary-cross-relations
    Role: cross-relations
  - Name: module.bc.zstd
    Type: llvm-container
  - Name: input
    Type: binary
  - Name: object.o
    Type: object
  - Name: output
    Type: translated
  - Name: assembly-internal.yml.tar.gz
    Type: function-assembly-internal
  - Name: assembly.ptml.tar.gz
    Type: function-assembly-ptml
  - Name: call-graph.svg.yml
    Type: call-graph-svg
  - Name: call-graph-slice.svg.tar.gz
    Type: call-graph-slice-svg
  - Name: cfg.svg.tar.gz
    Type: function-control-flow-graph-svg
  - Name: cfg.yml.tar.gz
    Type: cfg
Branches:
  - Steps:
      - Name: initial
        Analyses:
          - Name: apply-diff
            Type: apply-diff
            UsedContainers: []
          - Name: verify-diff
            Type: verify-diff
            UsedContainers: []
          - Name: set-global
            Type: set-global
            UsedContainers: []
          - Name: verify-global
            Type: verify-global
            UsedContainers: []
          - Name: import-binary
            Type: import-binary
            UsedContainers: [input]
          - Name: import-well-known-models
            Type: import-well-known-models
            UsedContainers: []
          - Name: convert-functions-to-cabi
            Type: convert-functions-to-cabi
            UsedContainers: []
      - Name: lift
        Pipes:
          - Type: lift
            UsedContainers: [input, module.bc.zstd]
          - Type: llvm-pipe
            UsedContainers: [module.bc.zstd]
            Passes: [globaldce]
        Artifacts:
          Container: module.bc.zstd
          Kind: root
          SingleTargetFilename: module_lifted.ll
        Analyses:
          - Name: detect-abi
            Type: detect-abi
            UsedContainers: [module.bc.zstd]
      - Name: isolate
        Pipes:
          - Type: collect-cfg
            UsedContainers: [module.bc.zstd, cfg.yml.tar.gz]
          - Type: isolate
            UsedContainers: [cfg.yml.tar.gz, module.bc.zstd]
          - Type: attach-debug-info-to-isolated
            UsedContainers: [cfg.yml.tar.gz, module.bc.zstd]
          - Type: process-call-graph
            UsedContainers: [cfg.yml.tar.gz, cross-relations.yml]
        Artifacts:
          Container: module.bc.zstd
          Kind: isolated
          SingleTargetFilename: module_isolated.ll
      - Name: enforce-abi
        Pipes:
          - Type: llvm-pipe
            UsedContainers: [module.bc.zstd]
            Passes:
              - drop-root
          - Type: enforce-abi
            UsedContainers: [cfg.yml.tar.gz, module.bc.zstd]
          - Type: llvm-pipe
            UsedContainers: [module.bc.zstd]
            Passes:
              - strip-debug-info-from-helpers
              # Note: we're running promote-csvs twice: it is important to run
              #       it before inline-helpers so that mem2reg can constant
              #       propagate helper arguments that are constant. This enables
              #       us to inline less code, in particular for helpers such as
              #       `cc_compute_c` and `cc_compute_all`.
              - promote-csvs
              - mem2reg
              - inline-helpers
          - Type: attach-debug-info-to-abi-enforced
            UsedContainers: [cfg.yml.tar.gz, module.bc.zstd]
          - Type: llvm-pipe
            UsedContainers: [module.bc.zstd]
            Passes:
              - promote-csvs
              - remove-exceptional-functions

        Artifacts:
          Container: module.bc.zstd
          Kind: csvs-promoted
          SingleTargetFilename: module_abienforced.ll
  - From: isolate
    Steps:
      - Name: emit-cfg
        Pipes: []
        Artifacts:
          Container: cfg.yml.tar.gz
          Kind: cfg
          SingleTargetFilename: cfg.yml.tar.gz
  - From: isolate
    Steps:
      - Name: hexdump
        Pipes:
          - Type: hex-dump
            UsedContainers: [input, module.bc.zstd, cfg.yml.tar.gz, hex.dump]
        Artifacts:
          Container: hex.dump
          Kind: hex-dump
          SingleTargetFilename: hex_dump.hex
  - From: isolate
    Steps:
      - Name: render-svg-call-graph
        Pipes:
          - Type: yield-call-graph
            UsedContainers: [cross-relations.yml, call-graph.svg.yml]
        Artifacts:
          Container: call-graph.svg.yml
          Kind: call-graph-svg
          SingleTargetFilename: call-graph.svg
  - From: isolate
    Steps:
      - Name: render-svg-call-graph-slice
        Pipes:
          - Type: yield-call-graph-slice
            UsedContainers: [cfg.yml.tar.gz, cross-relations.yml, call-graph-slice.svg.tar.gz]
        Artifacts:
          Container: call-graph-slice.svg.tar.gz
          Kind: call-graph-slice-svg
          SingleTargetFilename: call-graph-slice.svg
  - From: isolate
    Steps:
      - Name: process-assembly
        Pipes:
          - Type: process-assembly
            UsedContainers: [input, cfg.yml.tar.gz, assembly-internal.yml.tar.gz]
      - Name: disassemble
        Pipes:
          - Type: yield-assembly
            UsedContainers: [assembly-internal.yml.tar.gz, assembly.ptml.tar.gz]
        Artifacts:
          Container: assembly.ptml.tar.gz
          Kind: function-assembly-ptml
          SingleTargetFilename: disassembly.S
  - From: process-assembly
    Steps:
      - Name: render-svg-cfg
        Pipes:
          - Type: yield-cfg
            UsedContainers: [assembly-internal.yml.tar.gz, cfg.svg.tar.gz]
        Artifacts:
          Container: cfg.svg.tar.gz
          Kind: function-control-flow-graph-svg
          SingleTargetFilename: cfg.svg
  - From: lift
    Steps:
      - Name: recompile
        Pipes:
          - Type: link-support
            UsedContainers: [module.bc.zstd]
          - Type: llvm-pipe
            UsedContainers: [module.bc.zstd]
            Passes: [O2]
            EnabledWhen: [O2]
          - Type: llvm-pipe
            UsedContainers: [module.bc.zstd]
            Passes: [drop-opaque-return-address]
          - Type: compile
            UsedContainers: [module.bc.zstd, object.o]
          - Type: link-for-translation
            UsedContainers: [input, object.o, output]
        Artifacts:
          Container: output
          Kind: translated
          SingleTargetFilename: translated-binary
  - From: isolate
    Steps:
      - Name: recompile-isolated
        Pipes:
          - Type: llvm-pipe
            UsedContainers: [module.bc.zstd]
            Passes: [invoke-isolated-functions]
          - Type: link-support
            UsedContainers: [module.bc.zstd]
          - Type: llvm-pipe
            UsedContainers: [module.bc.zstd]
            Passes: [O2]
            EnabledWhen: [O2]
          - Type: llvm-pipe
            UsedContainers: [module.bc.zstd]
            Passes: [drop-opaque-return-address]
          - Type: compile-isolated
            UsedContainers: [module.bc.zstd, object.o]
          - Type: link-for-translation
            UsedContainers: [input, object.o, output]
        Artifacts:
          Container: output
          Kind: translated
          SingleTargetFilename: isolated-translated-binary
AnalysesLists:
  - Name: revng-initial-auto-analysis
    Analyses:
      - import-binary
      - import-well-known-models
      - detect-abi
