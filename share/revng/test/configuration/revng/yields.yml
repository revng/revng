#
# This file is distributed under the MIT License. See LICENSE.md for details.
#

commands:
  - type: revng.assembly-internal
    from:
      - type: revng-qa.compiled
        filter: one-per-architecture
      - type: revng.abi-enforced-for-decompilation
    suffix: .yml.tar.gz
    command: |-
      MODEL="$$(temp)";
      revng model dump "$INPUT2" > "$$MODEL";
      revng pipeline
        -m "$$MODEL"
        -i "$INPUT1:begin/input"
        -i "$INPUT2:enforce-abi/module.ll"
        -o "$OUTPUT:process-assembly/assembly-internal.yml.tar.gz"
        --produce process-assembly/assembly-internal.yml.tar.gz/*:FunctionAssemblyInternal

  - type: revng.assembly-ptml
    from:
      - type: revng.assembly-internal
      - type: revng.abi-enforced-for-decompilation
    suffix: .ptml.tar.gz
    command: |-
      MODEL="$$(temp)";
      revng model dump "$INPUT2" > "$$MODEL";
      revng pipeline
        -m "$$MODEL"
        -i "$INPUT1:process-assembly/assembly-internal.yml.tar.gz"
        -o "$OUTPUT:disassemble/assembly.ptml.tar.gz"
        --produce disassemble/assembly.ptml.tar.gz/*:FunctionAssemblyPTML

  - type: revng.cfg-svg
    from:
      - type: revng.assembly-internal
      - type: revng.abi-enforced-for-decompilation
    suffix: .svg.tar.gz
    command: |-
      MODEL="$$(temp)";
      revng model dump "$INPUT2" > "$$MODEL";
      revng pipeline
        -m "$$MODEL"
        -i "$INPUT1:process-assembly/assembly-internal.yml.tar.gz"
        -o "$OUTPUT:render-svg-cfg/cfg.svg.tar.gz"
        --produce render-svg-cfg/cfg.svg.tar.gz/*:FunctionControlFlowGraphSVG

  - type: revng.cross-relations
    from:
      - type: revng-qa.compiled
        filter: one-per-architecture
      - type: revng.abi-enforced-for-decompilation
    suffix: .yml
    command: |-
      MODEL="$$(temp)";
      revng model dump "$INPUT2" > "$$MODEL";
      revng pipeline
        -m "$$MODEL"
        -i "$INPUT1:begin/input"
        -i "$INPUT2:enforce-abi/module.ll"
        -o "$OUTPUT:isolate/cross-relations.yml"
        --produce isolate/cross-relations.yml/:BinaryCrossRelations

  - type: revng.call-graph-svg
    from:
      - type: revng.cross-relations
      - type: revng.abi-enforced-for-decompilation
    suffix: .svg.yml
    command: |-
      MODEL="$$(temp)";
      revng model dump "$INPUT2" > "$$MODEL";
      revng pipeline
        -m "$$MODEL"
        -i "$INPUT1:isolate/cross-relations.yml"
        -o "$OUTPUT:render-svg-call-graph/call-graph.svg.yml"
        --produce render-svg-call-graph/call-graph.svg.yml/:CallGraphSVG

  - type: revng.call-graph-slice-svg
    from:
      - type: revng.cross-relations
      - type: revng.abi-enforced-for-decompilation
      - type: revng-qa.compiled
        filter: one-per-architecture
    suffix: .svg.tar.gz
    command: |-
      MODEL="$$(temp)";
      revng model dump "$INPUT2" > "$$MODEL";
      revng pipeline
        -m "$$MODEL"
        -i "$INPUT1:isolate/cross-relations.yml"
        -i "$INPUT2:enforce-abi/module.ll"
        -i "$INPUT3:begin/input"
        -o "$OUTPUT:render-svg-call-graph-slice/call-graph-slice.svg.tar.gz"
        --produce render-svg-call-graph-slice/call-graph-slice.svg.tar.gz/*:CallGraphSliceSVG
