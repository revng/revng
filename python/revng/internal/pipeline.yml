#
# This file is distributed under the MIT License. See LICENSE.md for details.
#

containers:
  - name: binaries-container
    type: BinariesContainer
  - name: llvm-root
    type: LLVMRootContainer
  - name: model-header
    type: CBytesContainer
  - name: model-types
    type: PTMLCTypeContainer
  - name: cfg-map
    type: CFGMap
  - name: llvm-functions
    type: LLVMFunctionContainer

branches:
  files-imported:
    tasks:
      - pipe: ImportFiles
        arguments: [binaries-container]

  lift:
    from: files-imported
    tasks:
      - pipe: Lift
        arguments: [binaries-container, llvm-root]
      - pipe: PureLLVMPassesRootPipe
        arguments: [llvm-root]
        configuration:
          Passes:
            - globaldce
      - savepoint: lifted
        containers: [llvm-root]
        artifacts:
          - name: lift
            container: llvm-root

  collect-cfg:
    from: lift
    tasks:
      - pipe: CollectCFG
        arguments: [llvm-root, cfg-map]
      - savepoint: cfg-computed
        containers: [cfg-map]

  isolate:
    from: collect-cfg
    tasks:
      - pipe: Isolate
        arguments: [cfg-map, llvm-root, llvm-functions]

  emit-model-header:
    tasks:
      - pipe: ModelToHeader
        arguments: [model-header]
      - savepoint: model-header
        containers: [model-header]
        artifacts:
          - name: emit-model-header
            container: model-header

  emit-type-definition:
    tasks:
      - pipe: GenerateModelTypeDefinition
        arguments: [model-types]
      - savepoint: model-types
        containers: [model-types]
        artifacts:
          - name: emit-type-definitions
            container: model-types
