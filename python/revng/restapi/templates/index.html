{% extends "base.html" %}
{% block title %}Index{% endblock %}
{% block body %}
<h1>rev.ng cloud</h1>
<div class="container text-start">
  <div>
    Welcome, {{ g.user.username }}!<br>
    Your temporary directory is {{ g.user.tmpdir }}
  </div>

  <div>
    <label for="input-file">Input</label>
    <input id="input-file" type="file">
    <button class="btn btn-primary" onclick="setInputFile()">Set input file</button>
  </div>

  <div id="targets">
    <table id="targets-table">
      <thead>
        <tr>
          <td>Name</td>
          <td>Produce</td>
          <td>Ready</td>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
  "use strict";
  async function produce(step_name, container_name, kind_name, exact, path_components) {
    let target_path = `${path_components.join("/")}:${kind_name}`

    let response = await fetch(`/data/${step_name}/${container_name}/${target_path}`)
      .then(res => res.json());
    console.log("Response: ", response);
  }

  async function loadTargets() {
    let targets = await fetch("/step/targets").then(res => res.json());

    for (let [step_name, step_containers] of Object.entries(targets)) {
      for (let [container_name, container_targets] of Object.entries(step_containers)) {
        for (let target of container_targets) {
          let target_name = target.path_components.join("/");
          let target_fullname = `${step_name}/${container_name}/${target_name}:${target.kind}`;

          let target_properties = {
            step: step_name,
            container: container_name,
            kind: target.kind,
            exact: true,
            path_components: target.path_components,
          }

          let ready = target.ready ? "Yes" : "No";

          // TODO: passing the properties twice is ugly
          $('#targets-table').DataTable().row.add([
            target_fullname,
            target_properties,
            ready,
          ]);
        }
      }
    }
    $('#targets-table').DataTable().draw();
  }

  async function setInputFile() {
    let input_file = $("#input-file")[0];
    let formData = new FormData();
    formData.append("input", input_file.files[0]);

    let response = await fetch("/set-input/input", {
        method: "POST",
        credentials: "include",
        body: formData,
    }).then(res => res.json());

    // TODO: do not reload the page, reload the targets instead
    window.location.reload();
  }

  $(function(){
    $('#targets-table').DataTable({
      autoWidth: true,
      columns: [
        null,
        {
          render: function(data, type, row) {
            let produce_button = $("<button>");
            produce_button.text("Produce");
            produce_button.addClass(["produce-btn", "btn", "btn-primary", "btn-sm"]);
            return produce_button.outerHTML();
          },
        },
        null
      ],
    })
    $("#targets-table tbody").on("click", "button.produce-btn", async function() {
      let data = $("#targets-table").DataTable().row($(this).parents("tr")).data()[1];
      await produce(data.step, data.container, data.kind, data.exact, data.path_components);
    });
    loadTargets();
  });
</script>
{% endblock %}
